<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fatos complementares</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background: #f1f1f1; display: flex; justify-content: center; align-items: center; height: 100vh; }
    .container { background: #fff; width: 100%; max-width: 400px; height: 100%; display: flex; flex-direction: column; }
    .topbar { background: #333; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; font-weight: bold; flex-shrink: 0; }
    .topbar .title { text-transform: none; }
    .topbar img { width: 22px; height: 22px; cursor: pointer; }

    .content { flex: 1; overflow-y: auto; padding: 12px 16px; }

    .card { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,.12); border: 1px solid #e9e9e9; padding: 12px; margin-bottom: 16px; }
    .label { font-size: 12px; color: #444; text-transform: uppercase; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; justify-content: center; }
    .label .req { color: #c00; font-weight: bold; }
    .valor-fato { font-weight: bold; color: #111; text-transform: uppercase; letter-spacing: .2px; }

    .center-title { text-align: center; font-weight: bold; color: #444; text-transform: uppercase; font-size: 12px; display: flex; align-items: center; gap: 6px; margin: 8px 0; justify-content: center; }
    .forma-row { display: flex; align-items: center; gap: 24px; margin: 6px 0 16px 0; font-size: 14px; justify-content: center; }

    .btn-add { width: 100%; background: #2f6f73; color: #fff; border: none; border-radius: 6px; padding: 14px 16px; font-weight: bold; letter-spacing: .4px; cursor: pointer; }
    .btn-add:active { transform: scale(0.99); }

    .lista { margin-top: 14px; }
    .item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; background: #fafafa; }
    .item .texto { flex: 1; font-size: 13px; font-weight: 600; text-transform: uppercase; color: #333; }

    .form-select { width: 100%; display: block; padding: 10px; padding-right: 28px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; background: #fff; text-transform: uppercase; text-align-last: center; -moz-text-align-last: center; text-align: center; }
    .sep { height: 1px; background: #e5e5e5; margin: 8px 0 12px 0; }

    .actions { display: flex; gap: 8px; }
    .icon-btn { border: none; background: transparent; cursor: pointer; padding: 4px; }
    .icon-btn img { width: 20px; height: 20px; display: block; }

    /* Indicador de páginas (mesmo do fato-ba) */
    .pager-dots { display:flex; justify-content:center; align-items:center; gap:8px; padding:6px 0 2px 0; }
    .pager-dot { display:inline-block; width:8px; height:8px; border-radius:50%; background:#cdd2d3; }
    .pager-dot.active { background:#2f6f73; pointer-events:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <img src="img/back.png" alt="Voltar" onclick="history.back()">
      <div class="title">Fatos complementares</div>
      <span style="width:22px;height:22px;"></span>
    </div>

    <div class="content">
      <div class="card">
        <div class="label"><span class="req">*</span> FATO</div>
        <select id="selFato" class="form-select" required>
          <option value="" disabled selected>Selecione...</option>
        </select>
      </div>

      <div class="center-title"><span class="req" style="color:#c00">*</span> FORMA</div>
      <div class="forma-row">
        <label><input type="radio" name="forma" value="Tentado"> Tentado</label>
        <label><input type="radio" name="forma" value="Consumado"> Consumado</label>
      </div>
      <div class="sep"></div>

      <button class="btn-add" id="btnAdicionar">ADICIONAR</button>

      <div class="lista" id="lista"></div>
    </div>

    <!-- Indicador: 1º = registrar.html | 2º = fato-ba.html (esta tela compartilha o mesmo passo) -->
    <div class="pager-dots" aria-label="Progresso">
      <a class="pager-dot" href="registrar.html" title="Registrar"></a>
      <a class="pager-dot active" href="fato-ba.html" title="Fato"></a>
      <span class="pager-dot" title="Etapa 3"></span>
      <span class="pager-dot" title="Etapa 4"></span>
    </div>
  </div>

  <script>
    const KEY = 'fatosComplementares';
    const getList = () => JSON.parse(sessionStorage.getItem(KEY) || '[]');
    const setList = (arr) => sessionStorage.setItem(KEY, JSON.stringify(arr));

    const FATOS = [
      { codigo: '2070-23', desc: 'ABANDONO DE FUNCAO', tc: false },
      { codigo: '2088-15', desc: 'ABANDONO DE IDOSO', tc: true },
      { codigo: '2050-15', desc: 'ABANDONO INTELECTUAL', tc: false },
      { codigo: '2050-10', desc: 'ABANDONO MATERIAL', tc: false },
      { codigo: '2125-4',  desc: 'ABUSO DE INCAPAZ', tc: true },
      { codigo: '9100-22', desc: 'ACIDENTE DE TRABALHO', tc: false },
      { codigo: '9100-24', desc: 'ACIDENTE DE TRANSITO COM DANOS MATERIAIS', tc: false },
      { codigo: '9100-32', desc: 'ACIDENTE DE TRANSITO, VEICULO OFICIAL COM DANOS', tc: false },
      { codigo: '9100-31', desc: 'ACIDENTE DE TRANSITO, VEICULO OFICIAL COM LESOES', tc: true },
      { codigo: '2065-9',  desc: 'ADULTERACAO DE SINAL IDENTIFICADOR DE VEICULO', tc: false },
      { codigo: '2025-69', desc: 'OUTROS ROUBOS', tc: false },
      { codigo: '2025-42', desc: 'ROUBO A CASA LOTÉRICA', tc: false },
      { codigo: '2025-95', desc: 'ROUBO A ESTABELEC. DE ENSINO', tc: false },
      { codigo: '2025-63', desc: 'ROUBO A ESTABELECIMENTO BANCÁRIO', tc: false },
      { codigo: '2025-64', desc: 'ROUBO A ESTABELECIMENTO COM LESÕES', tc: false },
    ];

    const selFato = document.getElementById('selFato');
    function preencherSelectFato(){
      FATOS.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.desc;
        opt.textContent = `${f.desc}`;
        selFato.appendChild(opt);
      });
    }
    preencherSelectFato();

    const lista = document.getElementById('lista');
    function render(){
      const data = getList();
      lista.innerHTML = '';
      if (!data.length) {
        const p = document.createElement('p');
        p.style.color = '#666'; p.style.fontSize = '13px'; p.textContent = 'Nenhum fato complementar adicionado.';
        lista.appendChild(p);
        return;
      }
      data.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `
          <div class="texto">${it.fato}</div>
          <div class="actions">
            <button class="icon-btn editar" title="Editar" aria-label="Editar">
              <img src="img/editar.png" alt="Editar">
            </button>
            <button class="icon-btn excluir" title="Excluir" aria-label="Excluir">
              <img src="img/excluir.png" alt="Excluir">
            </button>
          </div>
        `;
        row.querySelector('.editar').addEventListener('click', ()=>{
          const textDiv = row.querySelector('.texto');
          const select = document.createElement('select');
          select.className = 'form-select';
          FATOS.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.desc;
            opt.textContent = f.desc;
            select.appendChild(opt);
          });
          select.value = it.fato;
          textDiv.innerHTML = '';
          textDiv.appendChild(select);
          select.focus();
          select.addEventListener('change', ()=>{
            const all = getList();
            all[idx].fato = select.value;
            setList(all);
            render();
          });
          select.addEventListener('keydown', (e)=>{
            if (e.key === 'Enter'){
              const all = getList();
              all[idx].fato = select.value;
              setList(all);
              render();
            } else if (e.key === 'Escape'){
              render();
            }
          });
          select.addEventListener('blur', ()=> { render(); });
        });
        row.querySelector('.excluir').addEventListener('click', ()=>{
          const all = getList();
          all.splice(idx,1);
          setList(all);
          render();
        });
        lista.appendChild(row);
      });
    }

    document.getElementById('btnAdicionar').addEventListener('click', () => {
      const forma = document.querySelector('input[name="forma"]:checked');
      const fatoAtual = selFato.value;

      if (!fatoAtual) { alert('Selecione o FATO.'); selFato.focus(); return; }
      if (!forma) { alert('Selecione a FORMA.'); return; }

      const arr = getList();
      // --- Bloqueio de duplicados por FATO (case/trim insensitive) ---
      const jaExiste = arr.some(it => (it.fato || '').trim().toUpperCase() === fatoAtual.trim().toUpperCase());
      if (jaExiste) { alert('Este FATO já foi adicionado.'); return; }

      const item = { fato: fatoAtual, forma: forma.value };
      arr.push(item);
      setList(arr);
      render();

      sessionStorage.setItem('fatoSelecionado', fatoAtual);
      sessionStorage.setItem('formaSelecionada', forma.value);
    });

    render();
  </script>
</body>
</html>
