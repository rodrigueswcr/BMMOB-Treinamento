<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Participante - Dados Gerais (3)</title>
  <style>
    *{box-sizing:border-box}
    html, body { height:100%; }
    body{
      margin:0;font-family:Arial,Helvetica,sans-serif;background:#f1f1f1;
      display:flex;justify-content:center;align-items:center;min-height:100dvh;
    }
    .container{ background:#fff;width:100%;max-width:400px;height:100dvh;display:flex;flex-direction:column; }
    .topbar{ background:#333;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;font-weight:bold;flex-shrink:0; }
    .topbar .title{ text-transform:uppercase; letter-spacing:.5px; }
    .topbar img{ width:22px;height:22px;cursor:pointer; }
    .content{flex:1;overflow-y:auto;padding:12px 16px 16px 16px}
    .subtitle-row{ display:flex;align-items:center;justify-content:space-between; margin:2px 0 12px 0; }
    .subtitle{ color:#444;font-weight:bold; }
    .btn-ghost{ border:1px solid #ccc;background:#fff;color:#555;border-radius:6px;padding:8px 12px;font-weight:bold;font-size:12px;opacity:.7; }
    label{display:block;font-size:12px;color:#2f6f73;margin:10px 0 6px}
    .req::before{content:"* "; color:#d00; font-weight:bold}
    input, select{ width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:6px;background:#fff;font-size:14px;outline:none; }
    input:focus, select:focus{ border-color:#888; }
    .search-line{ display:flex; gap:10px; align-items:center; }
    .search-line input{ flex:1; }
    .btn{ border:1px solid #ccc; background:#fff; border-radius:6px; padding:10px 14px; font-weight:bold; cursor:pointer; font-size:13px; color:#333; }
    .pager-dots{ display:flex;justify-content:center;align-items:center;gap:8px;padding:8px 0 }
    .pager-dot{ display:inline-block;width:8px;height:8px;border-radius:50%; background:#cdd2d3;text-decoration:none; }
    .pager-dot.active{ background:#2f6f73; }
    /* Modal */
    .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{ width:min(320px, 90vw); border-radius:10px; overflow:hidden; background:#fff; box-shadow:0 10px 30px rgba(0,0,0,.25); animation:pop .14s ease-out; }
    @keyframes pop{ from{ transform:scale(.96); opacity:.6 } to{ transform:scale(1); opacity:1 } }
    .modal-header{ background:#e74c3c; color:#fff; font-weight:bold; padding:12px 14px; font-size:16px; }
    .modal-body{ padding:12px 14px; color:#444; font-size:14px; line-height:1.35; }
    .modal-body ul{ margin:6px 0 0 18px; padding:0; }
    .modal-footer{ display:flex; justify-content:flex-end; padding:10px 12px; background:#f7f7f7; }
    .modal-btn{ border:1px solid #ddd; background:#fff; border-radius:6px; padding:8px 14px; font-weight:bold; cursor:pointer; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <img src="img/back.png" alt="Voltar" id="btnBack">
      <div class="title">DADOS GERAIS</div>
      <img src="img/check.png" alt="Confirmar" id="btnSave">
    </div>

    <div class="content">
      <div class="subtitle-row">
        <div class="subtitle">IDENTIFICAÇÃO PARTICIPANTE</div>
        <button class="btn-ghost" type="button" id="btnFoto">VISUALIZAR FOTO</button>
      </div>

      <label class="req" for="nome">Nome</label>
      <input id="nome" type="text" placeholder="">

      <label for="nomeSocial">Nome Social</label>
      <input id="nomeSocial" type="text" placeholder="">

      <label class="req" for="dataNasc">Data Nascimento</label>
      <input id="dataNasc" type="date" placeholder="">

      <label for="cpf">CPF</label>
      <div class="search-line">
        <input id="cpf" type="text" inputmode="numeric" placeholder="">
        <button class="btn" type="button" id="btnBuscarCPF">PESQUISAR</button>
      </div>

      <label class="req" for="nomePai">Nome do Pai</label>
      <input id="nomePai" type="text" placeholder="">

      <label class="req" for="nomeMae">Nome da Mãe</label>
      <input id="nomeMae" type="text" placeholder="">
    </div>

    <div class="pager-dots" aria-label="Progresso">
      <a class="pager-dot" href="dados-gerais1.html" aria-label="Página 1"></a>
      <a class="pager-dot" href="dados-gerais2.html" aria-label="Página 2"></a>
      <a class="pager-dot active" href="dados-gerais3.html" aria-label="Página 3"></a>
      <a class="pager-dot" href="dados-gerais4.html" aria-label="Página 4"></a>
    </div>
  </div>

  <!-- Importa o banco compartilhado -->
  <script src="db.js"></script>

  <!-- Modal -->
  <div class="modal-overlay" id="errorOverlay" role="dialog" aria-modal="true" aria-labelledby="errTitle">
    <div class="modal">
      <div class="modal-header" id="errTitle">Um ou mais erros encontrados</div>
      <div class="modal-body"><ul id="errList"></ul></div>
      <div class="modal-footer"><button class="modal-btn" id="btnOk">OK</button></div>
    </div>
  </div>

  <script>
    /* ===== Consulta por CPF (independente, usando db.js) ===== */
    const cpfInput = document.getElementById('cpf');

    // Só dígitos
    cpfInput.addEventListener('input', e=>{ e.target.value = e.target.value.replace(/\D/g,''); });

    // Enter dispara a busca
    cpfInput.addEventListener('keydown', e=>{
      if(e.key === 'Enter'){ e.preventDefault(); document.getElementById('btnBuscarCPF').click(); }
    });

    document.getElementById('btnBuscarCPF').addEventListener('click', ()=>{
      const cpf = (cpfInput.value || '').trim();
      if(!cpf){ alert('Informe o CPF para pesquisar.'); return; }
      const registro = Object.values(cnhDB).find(r => r.cpf === cpf);
      if(registro){
        document.getElementById('nome').value     = registro.condutor || '';
        document.getElementById('dataNasc').value = registro.dataNasc || ''; // ISO no input[type="date"]
        document.getElementById('nomePai').value  = registro.nomePai  || '';
        document.getElementById('nomeMae').value  = registro.nomeMae  || '';
      }else{
        alert('CPF não encontrado.');
      }
    });

    // ===== Navegação =====
    document.getElementById('btnBack').addEventListener('click', () => {
      window.location.href = 'dados-gerais2.html';
    });
    document.getElementById('btnSave').addEventListener('click', () => {
      const erros = validarFormulario();
      if (erros.length){ mostrarErros(erros); return; }
      window.location.href = 'dados-gerais4.html';
    });
    document.getElementById('btnFoto').addEventListener('click', () => {
      alert('Visualização de foto não implementada nesta tela.');
    });

    // ===== Validação (nome com sobrenome + data nasc) =====
    const ignoraPalavras = new Set(['de','da','do','das','dos','e']);
    function temSobrenome(str){
      if(!str) return false;
      const tokens = str.normalize('NFD').replace(/\p{Diacritic}/gu,'')
        .trim().split(/\s+/).filter(t => t.length > 1 && !ignoraPalavras.has(t.toLowerCase()));
      return tokens.length >= 2;
    }
    function validarDataNascimento(d){
      if(!d) return {ok:false, msg:'Informe a Data de Nascimento.'};
      const dt = new Date(d); if(isNaN(+dt)) return {ok:false, msg:'Data de Nascimento inválida.'};
      const hoje = new Date();
      if(dt > hoje) return {ok:false, msg:'A Data de Nascimento não pode ser futura.'};
      const idade = (hoje - dt) / (365.25*24*3600*1000);
      if(idade > 120) return {ok:false, msg:'A Data de Nascimento é incompatível (acima de 120 anos).'};
      return {ok:true};
    }
    function validarFormulario(){
      const erros = [];
      const nome     = document.getElementById('nome').value.trim();
      const nomeSoc  = document.getElementById('nomeSocial').value.trim();
      const nomePai  = document.getElementById('nomePai').value.trim();
      const nomeMae  = document.getElementById('nomeMae').value.trim();
      const dataNasc = document.getElementById('dataNasc').value;

      if(!temSobrenome(nome))    erros.push('O nome deve conter pelo menos duas partículas.');
      if(nomeSoc && !temSobrenome(nomeSoc)) erros.push('O nome social deve conter pelo menos duas partículas.');
      if(!temSobrenome(nomePai)) erros.push('O nome do pai deve conter pelo menos duas partículas.');
      if(!temSobrenome(nomeMae)) erros.push('O nome da mãe deve conter pelo menos duas partículas.');

      const vData = validarDataNascimento(dataNasc);
      if(!vData.ok) erros.push(vData.msg);
      return erros;
    }

    // ===== Modal de erro =====
    const overlay = document.getElementById('errorOverlay');
    const listEl  = document.getElementById('errList');
    document.getElementById('btnOk').addEventListener('click', ()=> overlay.style.display='none');
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) overlay.style.display='none'; });
    function mostrarErros(msgs){
      listEl.innerHTML = '';
      msgs.forEach(m=>{ const li=document.createElement('li'); li.textContent=m; listEl.appendChild(li); });
      overlay.style.display='flex';
    }
  </script>
</body>
</html>
