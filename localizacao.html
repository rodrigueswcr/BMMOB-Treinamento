<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Localização - Boletim</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    *{box-sizing:border-box}
    :root{
      --vh: 1vh;                 /* ajustado via JS p/ Edge/Windows */
      scrollbar-gutter: stable;  /* estabilidade global */
    }
    html, body { height: 100%; }
    body{
      margin:0;font-family:Arial,Helvetica,sans-serif;background:#f1f1f1;
      display:flex;justify-content:center;align-items:center;height:100vh;
      overflow:hidden; /* scroll só dentro da .content (padrão) */
    }

    /* Container padronizado com fato-ba */
    .container{
      background:#fff;
      width:100%;
      max-width:400px;
      height:calc(var(--vh, 1vh) * 100);
      display:flex;flex-direction:column
    }
    @supports (height: 100dvh) {
      .container { height: 100dvh; }
    }

    /* TOPBAR (igual fato-ba) */
    .topbar{
      background:#333;color:#fff;display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;font-weight:bold;flex-shrink:0
    }
    .topbar .title{ text-transform:uppercase; letter-spacing:.5px; }
    .topbar img{ width:22px; height:22px; cursor:pointer; }

    /* CONTENT com largura estável mesmo com/sem scroll */
    .content{
      flex:1;overflow-y:auto;padding:4px 16px 0 16px;
      scrollbar-gutter: stable both-edges; /* <- mantém bordas externas alinhadas */
    }

    /* “Card” sem moldura/recuo para igualar largura visual ao fato-ba */
    .card{background:transparent;border:0;padding:0;margin:0}
    .card-title{display:flex;align-items:center;justify-content:space-between;font-weight:bold;color:#333;margin:6px 0 10px}

    /* GEO BTN 2x */
    .geo-btn{width:68px;height:68px;border-radius:12px;border:none;background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0}
    .geo-btn img{width:36px;height:36px}

    .row{display:flex;gap:10px}
    .col{flex:1}
    label{display:block;font-size:12px;color:#666;margin:8px 0 4px}
    .req::before{content:"* ";color:#d00;font-weight:bold}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #d9d9d9;border-radius:6px;background:#fff;font-size:14px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#888}
    textarea{resize:vertical;min-height:70px}
    .thin{margin:8px 0;border-top:1px solid #eee}

    /* PAGER fora da .content (igual fato-ba) */
    .pager-dots{display:flex;justify-content:center;align-items:center;gap:8px;padding:6px 0 2px 0}
    .pager-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#cdd2d3}
    .pager-dot.active{background:#2f6f73}

    /* FOOTER padronizado */
    .footer{display:flex;justify-content:space-around;background-color:#2f6f73;padding:10px 0;flex-shrink:0}
    .footer img{cursor:pointer;width:28px;height:28px;transition:.2s;filter:grayscale(30%) brightness(0.9)}
    .footer img:hover{width:32px;height:32px;filter:grayscale(0%) brightness(1.2)}
    .footer img.active{filter:grayscale(0%) brightness(1.1) contrast(1.0)}

    .hint{font-size:11px;color:#666;margin-top:6px}

    /* Overlay do mapa com mesma métrica de altura real */
    .map-overlay{position:fixed;inset:0;background:#fff;display:none;z-index:9999}
    .map-topbar{background:#333;color:#fff;display:flex;align-items:center;gap:12px;padding:10px 12px;font-weight:bold}
    .map-topbar .icon{width:22px;height:22px;cursor:pointer}
    .map-title{flex:1;text-align:center}
    .map-search{padding:8px 12px;background:#f4f4f4}
    .map-search input{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px}
    #leafletMap{
      width:100%;
      height:calc((var(--vh, 1vh) * 100) - 96px); /* topbar + busca do mapa */
    }
    @supports (height: 100dvh) {
      #leafletMap{ height:calc(100dvh - 96px); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <img src="img/back.png" alt="Voltar" id="btnBack">
      <div class="title">BOLETIM</div>
      <img src="img/check.png" alt="Avançar" id="btnNext">
    </div>

    <div class="content">
      <div class="card">
        <div class="card-title">
          <span>Localização</span>
          <button class="geo-btn" id="btnGeo" title="Selecionar no mapa">
            <img src="img/gps.png" alt="GPS">
          </button>
        </div>

        <!-- CIDADE (obrigatório) -->
        <label for="cidade" class="req">Cidade</label>
        <select id="cidade" name="cidade" required>
          <option value="Santa Maria">Santa Maria</option>
          <option value="Porto Alegre">Porto Alegre</option>
          <option value="Caxias do Sul">Caxias do Sul</option>
          <option value="Pelotas">Pelotas</option>
        </select>

        <!-- LOGRADOURO (obrigatório) -->
        <label for="logradouro" class="req">Logradouro</label>
        <input id="logradouro" name="logradouro" type="text" placeholder="Rua / Avenida / Estrada" required>

        <div class="row">
          <div class="col">
            <label for="bairro">Bairro</label>
            <input id="bairro" name="bairro" type="text">
          </div>
          <div class="col" style="max-width:120px">
            <label for="numero">Nº</label>
            <input id="numero" name="numero" type="text" inputmode="numeric" pattern="[0-9]*">
          </div>
        </div>

        <div class="thin"></div>

        <div class="row">
          <div class="col">
            <label for="complemento">Complemento</label>
            <input id="complemento" name="complemento" type="text">
          </div>
          <div class="col">
            <!-- ÁREA (obrigatório) -->
            <label for="area" class="req">Área</label>
            <select id="area" name="area" required>
              <option value="" selected disabled>Selecione</option>
              <option>Urbana</option>
              <option>Suburbana</option>
              <option>Rural</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <!-- TIPO/LOCAL (obrigatório) -->
            <label for="tipoLocal" class="req">Tipo/local</label>
            <select id="tipoLocal" name="tipoLocal" required>
              <option value="" selected disabled>Selecione</option>
              <option>Via pública</option>
              <option>Estab.diversão</option>
              <option>Residência</option>
              <option>Estab.comercial</option>
              <option>Estab.ensino</option>
              <option>Interior coletivos</option>
              <option>Hospitais/clínicas</option>
              <option>Metrô/rodoviária</option>
              <option>Outros</option>
            </select>
          </div>
          <div class="col">
            <label for="tipoEstab">Tipo estabelecimento</label>
            <select id="tipoEstab" name="tipoEstab">
              <option value="" selected disabled>Selecione</option>
              <option>Bancos e similares</option>
              <option>Joalherias</option>
              <option>Postos gasolina/garagem</option>
              <option>Supermercados</option>
              <option>Bares/restaurantes</option>
              <option>Farmácias/drogarias</option>
              <option>Hotéis e similares</option>
              <option>Lojas/outros</option>
            </select>
          </div>
        </div>

        <label for="referencia" style="margin-top:10px;">Ponto de referência</label>
        <textarea id="referencia" name="referencia" placeholder="Descreva um ponto de referência"></textarea>

        <div id="geoHint" class="hint"></div>
      </div>
    </div>

    <!-- Pager Unificado -->
    <div class="pager-dots" aria-label="Progresso">
      <a class="pager-dot" href="registrar.html" title="Etapa 1: Registrar"></a>
      <a class="pager-dot" href="questionario.html" title="Etapa 2: Questionário"></a>
      <a class="pager-dot" href="fato-ba.html" title="Etapa 3: Fato"></a>
      <a class="pager-dot active" href="localizacao.html" title="Etapa 4: Localização"></a>
      <a class="pager-dot" href="historico.html" title="Etapa 5: Histórico"></a>
    </div>

    <!-- Footer igual ao registrar.html -->
    <div class="footer">
      <img src="img/doc.png" alt="Boletim" class="active">
      <img src="img/user.png" alt="Indivíduo">
      <img src="img/object.png" alt="Objeto">
      <img src="img/gun.png" alt="Arma">
      <img src="img/car.png" alt="Veículo">
      <img src="img/doc.png" alt="Outros">
    </div>
  </div>

  <!-- Overlay do Mapa -->
  <div class="map-overlay" id="mapOverlay" aria-hidden="true">
    <div class="map-topbar">
      <img class="icon" src="img/back.png" alt="Fechar" id="mapBack">
      <div class="map-title">Localização</div>
      <img class="icon" src="img/check.png" alt="Usar este ponto" id="mapConfirm">
    </div>
    <div class="map-search">
      <input id="mapSearch" type="search" placeholder="Pesquisar endereço, bairro, ponto..." autocomplete="off">
    </div>
    <div id="leafletMap"></div>
  </div>

  <script>
    /* Fix de altura baseado no viewport real (Edge/Windows) */
    function setVH(){
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVH();
    window.addEventListener('resize', setVH);

    /* Footer visual */
    (function footerSelectable(){
      const icons=document.querySelectorAll('.footer img');
      icons.forEach(img=>img.addEventListener('click',()=>{
        icons.forEach(i=>i.classList.remove('active')); img.classList.add('active');
      }));
    })();

    /* Persistência de campos */
    const KEYS = {
      cidade:'loc_cidade', logradouro:'loc_logradouro', bairro:'loc_bairro',
      numero:'loc_numero', complemento:'loc_complemento', area:'loc_area',
      tipoLocal:'loc_tipoLocal', tipoEstab:'loc_tipoEstab', referencia:'loc_referencia',
      lat:'loc_lat', lon:'loc_lon'
    };

    function saveForm(){
      sessionStorage.setItem(KEYS.cidade, document.getElementById('cidade').value || '');
      sessionStorage.setItem(KEYS.logradouro, document.getElementById('logradouro').value || '');
      sessionStorage.setItem(KEYS.bairro, document.getElementById('bairro').value || '');
      sessionStorage.setItem(KEYS.numero, document.getElementById('numero').value || '');
      sessionStorage.setItem(KEYS.complemento, document.getElementById('complemento').value || '');
      sessionStorage.setItem(KEYS.area, document.getElementById('area').value || '');
      sessionStorage.setItem(KEYS.tipoLocal, document.getElementById('tipoLocal').value || '');
      sessionStorage.setItem(KEYS.tipoEstab, document.getElementById('tipoEstab').value || '');
      sessionStorage.setItem(KEYS.referencia, document.getElementById('referencia').value || '');
    }

    function setSelectValueByTextOrAppend(selectEl, valueText){
      if(!valueText) return;
      const v = String(valueText);
      let found = false;
      for(const opt of selectEl.options){
        if(opt.value.toLowerCase() === v.toLowerCase()){
          selectEl.value = opt.value; found = true; break;
        }
      }
      if(!found){
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        selectEl.appendChild(opt);
        selectEl.value = v;
      }
    }

    function restoreForm(){
      const cidadeSaved = sessionStorage.getItem(KEYS.cidade);
      if(cidadeSaved){ setSelectValueByTextOrAppend(document.getElementById('cidade'), cidadeSaved); }
      [['logradouro',KEYS.logradouro],['bairro',KEYS.bairro],['numero',KEYS.numero],['complemento',KEYS.complemento],['referencia',KEYS.referencia]]
      .forEach(([id,key])=>{ const v=sessionStorage.getItem(key); if(v!==null) document.getElementById(id).value=v; });
      const areaSaved = sessionStorage.getItem(KEYS.area);
      if(areaSaved){ setSelectValueByTextOrAppend(document.getElementById('area'), areaSaved); }
      const tLocalSaved = sessionStorage.getItem(KEYS.tipoLocal);
      if(tLocalSaved){ setSelectValueByTextOrAppend(document.getElementById('tipoLocal'), tLocalSaved); }
      const tEstabSaved = sessionStorage.getItem(KEYS.tipoEstab);
      if(tEstabSaved){ setSelectValueByTextOrAppend(document.getElementById('tipoEstab'), tEstabSaved); }
    }

    // Navegação topbar
    document.getElementById('btnBack').addEventListener('click', ()=>{ saveForm(); window.location.href = 'fato-ba.html'; });
    document.getElementById('btnNext').addEventListener('click', ()=>{
      const cidade = document.getElementById('cidade');
      const logradouro = document.getElementById('logradouro');
      const area = document.getElementById('area');
      const tipoLocal = document.getElementById('tipoLocal');
      if (!cidade.value) { alert('Selecione a CIDADE.'); cidade.focus(); return; }
      if (!logradouro.value.trim()) { alert('Preencha o LOGRADOURO.'); logradouro.focus(); return; }
      if (!area.value) { alert('Selecione a ÁREA.'); area.focus(); return; }
      if (!tipoLocal.value) { alert('Selecione o TIPO/LOCAL.'); tipoLocal.focus(); return; }
      saveForm();
      window.location.href = 'historico.html';
    });

    // Salvar ao alterar campos
    ['cidade','logradouro','bairro','numero','complemento','area','tipoLocal','tipoEstab','referencia']
      .forEach(id=>{
        const el = document.getElementById(id);
        const evt = el.tagName === 'SELECT' ? 'change' : 'input';
        el.addEventListener(evt, saveForm);
      });

    // Apenas números no Nº
    document.getElementById('numero').addEventListener('input', (e)=>{
      e.target.value = e.target.value.replace(/\D+/g,'').slice(0,6); saveForm();
    });

    /* Mapa (Leaflet) */
    const btn = document.getElementById('btnGeo');
    const hint = document.getElementById('geoHint');
    function setHint(msg){ hint.textContent = msg; }

    async function reverseGeocode(lat, lon){
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&addressdetails=1`;
      const res = await fetch(url, { headers: { "Accept": "application/json", "User-Agent": "BM-Boletim/1.0 (contato-exemplo@exemplo.br)" } });
      if(!res.ok) throw new Error("Falha no serviço de geocodificação");
      return res.json();
    }
    function fillFieldsFromAddress(address){
      const street = address.road || address.pedestrian || address.footway || address.cycleway || address.path || address.neighbourhood || "";
      document.getElementById('logradouro').value = street;
      if(address.house_number){
        document.getElementById('numero').value = address.house_number.replace(/\D+/g,'').slice(0,6);
      }
      const bairro = address.suburb || address.neighbourhood || address.city_district || address.quarter || "";
      document.getElementById('bairro').value = bairro;
      const cidade = address.city || address.town || address.village || address.municipality || address.county || "";
      setSelectValueByTextOrAppend(document.getElementById('cidade'), cidade);
      saveForm();
    }

    const cityCenters = {
      "Santa Maria": [-29.6868,-53.8149],
      "Porto Alegre": [-30.0346,-51.2177],
      "Caxias do Sul": [-29.1634,-51.1794],
      "Pelotas": [-31.7654,-52.3371]
    };
    let map, marker, overlayOpen = false;

    function openMap(lat, lon, zoom=16){
      const overlay = document.getElementById('mapOverlay');
      overlay.style.display = 'block';
      overlay.setAttribute('aria-hidden','false');
      overlayOpen = true;

      if(!map){
        map = L.map('leafletMap');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
        marker = L.marker([lat, lon], {draggable:true}).addTo(map);
        map.on('click', (e)=>{ marker.setLatLng(e.latlng); });
      }else{ marker.setLatLng([lat, lon]); }
      map.setView([lat, lon], zoom);
      setTimeout(()=> map.invalidateSize(), 50);
    }
    function closeMap(){
      const overlay = document.getElementById('mapOverlay');
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden','true');
      overlayOpen = false;
    }

    // Abrir mapa
    btn.addEventListener('click', async ()=>{
      setHint("");
      let lat=-15.78, lon=-47.93, zoom=4;
      const cidadeSel = document.getElementById('cidade').value;
      if (cityCenters[cidadeSel]){ [lat,lon]=cityCenters[cidadeSel]; zoom=13; }

      if('geolocation' in navigator){
        try{
          const pos = await new Promise((resolve, reject)=>{
            navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy:true, timeout: 8000, maximumAge: 0 });
          });
          lat = pos.coords.latitude; lon = pos.coords.longitude; zoom = 17;
        }catch(e){}
      }
      openMap(lat, lon, zoom);
    });

    // Fechar/confirmar mapa
    document.getElementById('mapBack').addEventListener('click', closeMap);
    document.getElementById('mapConfirm').addEventListener('click', async ()=>{
      if(!marker) return;
      const {lat, lng} = marker.getLatLng();
      try{
        setHint("Buscando endereço selecionado…");
        const data = await reverseGeocode(lat, lng);
        if(data && data.address){
          fillFieldsFromAddress(data.address);
          sessionStorage.setItem(KEYS.lat, String(lat));
          sessionStorage.setItem(KEYS.lon, String(lng));
          setHint("Endereço definido pelo mapa.");
        }else{ setHint("Não foi possível obter o endereço. Ajuste manualmente."); }
      }catch(err){ setHint("Erro ao converter ponto em endereço."); }
      closeMap();
    });

    // Busca no mapa (Enter)
    async function geocode(q){
      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&addressdetails=1&limit=1`;
      const res = await fetch(url, { headers: { "Accept":"application/json", "User-Agent":"BM-Boletim/1.0 (contato-exemplo@exemplo.br)" } });
      if(!res.ok) return null;
      const arr = await res.json();
      return Array.isArray(arr) && arr[0] ? arr[0] : null;
    }
    const mapSearch = document.getElementById('mapSearch');
    mapSearch.addEventListener('keydown', async (e)=>{
      if(e.key !== 'Enter') return;
      e.preventDefault();
      const q = mapSearch.value.trim(); if(!q) return;
      const r = await geocode(q);
      if(r){
        const lat = parseFloat(r.lat), lon = parseFloat(r.lon);
        map.setView([lat,lon], 17);
        marker.setLatLng([lat,lon]);
      }else{
        alert('Endereço não encontrado.');
      }
    });

    // Restaura
    restoreForm();

    /* ===== MOD 1: Salvar antes de navegar pelas bolinhas do pager ===== */
    document.querySelectorAll('.pager-dots a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        saveForm();
        window.location.href = a.getAttribute('href');
      });
    });

    // ESC fecha overlay
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && overlayOpen) closeMap(); });
  </script>

  <!-- SWIPE LATERAL -->
  <script>
  (function enableSwipePages(){
    const ROUTE = ['registrar.html','questionario.html','fato-ba.html','localizacao.html','historico.html'];
    const here = (location.pathname.split('/').pop() || 'localizacao.html').toLowerCase();
    const idx = ROUTE.indexOf(here);

    let x0=null, y0=null, t0=0;
    const THRESH = 50, MAX_TIME = 600, V_SLOPE = 0.5;
    const unify = (e)=> e.changedTouches ? e.changedTouches[0] : e;

    function onStart(e){ const p=unify(e); x0=p.clientX; y0=p.clientY; t0=Date.now(); }
    function onEnd(e){
      if(x0===null) return;
      const p=unify(e), dx=p.clientX-x0, dy=p.clientY-y0, dt=Date.now()-t0;
      const horizontal = Math.abs(dx)>THRESH && Math.abs(dy)<Math.abs(dx)*V_SLOPE && dt<MAX_TIME;
      if(horizontal){
        if(dx<0 && idx<ROUTE.length-1){
          saveForm();                 /* MOD 2: salva antes do swipe avançar */
          location.href=ROUTE[idx+1];
        } else if(dx>0 && idx>0){
          saveForm();                 /* MOD 2: salva antes do swipe voltar */
          location.href=ROUTE[idx-1];
        }
      }
      x0=null;
    }

    window.addEventListener('touchstart', onStart, {passive:true});
    window.addEventListener('touchend', onEnd, {passive:true});
  })();
  </script>
</body>
</html>
